<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vampuca AI Player</title>

  <!-- Reveal.js styles -->
  <link rel="stylesheet" href="https://unpkg.com/reveal.js/dist/reveal.css">
  <link rel="stylesheet" href="https://unpkg.com/reveal.js/dist/theme/black.css">

  <!-- –¢–≤–æ–∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏ —Å—Ç–∏–ª–∏ –ø–ª–µ–µ—Ä–∞ -->
  <style>
    /* –ë–∞–∑–æ–≤–∞—è –≤—ë—Ä—Å—Ç–∫–∞ */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background:black; color:white; overflow:hidden; user-select:none; }
    .player-container { position:relative; width:100vw; height:100vh; background:black; }

    /* Branding & dropdown */
    .studio-branding { position:absolute; top:1rem; right:1rem; z-index:1001; display:flex; gap:0.5rem; }
    .studio-brand-block { background:rgba(0,0,0,0.7); padding:0.5rem 0.75rem; border-radius:0.5rem; backdrop-filter:blur(12px); border:1px solid rgba(255,133,51,0.2); }
    .studio-name { color:hsl(14,100%,60%); font-weight:700; font-size:1.125rem; letter-spacing:0.05em; text-shadow:0 0 10px rgba(255,133,51,0.3); }
    .dropdown-button-container { position:absolute; top:1rem; left:1rem; background:rgba(0,0,0,0.7); padding:0.5rem; border-radius:0.5rem; backdrop-filter:blur(12px); border:1px solid rgba(255,133,51,0.2); z-index:1001; }
    .dropdown-button { background:none; border:none; color:hsl(14,100%,60%); cursor:pointer; padding:0.25rem; border-radius:0.25rem; transition:all .2s; }
    .dropdown-button:hover { color:white; background:rgba(255,133,51,0.1); }
    .dropdown-menu { position:absolute; top:100%; left:0; margin-top:.5rem; width:12rem; background:rgba(255,255,255,0.95); backdrop-filter:blur(16px); border-radius:.5rem; border:1px solid rgba(0,0,0,0.1); box-shadow:0 8px 32px rgba(0,0,0,0.3); max-height:60vh; overflow-y:auto; z-index:1002; display:none; opacity:0; transform:translateY(-10px); transition:all .3s; }
    .dropdown-menu.visible { display:block !important; opacity:1 !important; transform:translateY(0) !important; }
    .dropdown-header { padding:.5rem; font-weight:600; color:#333; }
    .chapter-list { display:flex; flex-direction:column; }
    .chapter-item { background:none; border:none; text-align:left; padding:.5rem; cursor:pointer; display:flex; justify-content:space-between; align-items:center; font-size:.9rem; color:#333; }
    .chapter-item.active { background:rgba(255,133,51,0.2); }
    .chapter-indicator { margin-left:.5rem; color:hsl(14,100%,60%); }

    /* Slide Counter */
    .slide-counter { position:absolute; bottom:1rem; left:50%; transform:translateX(-50%); z-index:1001; padding:.25rem .5rem; background:rgba(0,0,0,0.7); border-radius:.25rem; font-size:.875rem; }

    /* Video Container */
    .video-container { position:relative; width:100%; height:100%; display:flex; justify-content:center; align-items:center; }
    .main-video { width:100%; max-width:800px; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.5); }
    .loading-state { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); padding:1rem 1.5rem; border-radius:.5rem; display:flex; align-items:center; gap:.5rem; z-index:1002; }
    .loading-state.hidden { display:none; }
    .loading-spinner { width:24px; height:24px; border:3px solid rgba(255,255,255,0.3); border-top:3px solid #fff; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* Controls */
    .controls-container { position:absolute; bottom:3rem; left:50%; transform:translateX(-50%); display:flex; align-items:center; gap:1rem; z-index:1001; }
    .controls-container button { background:rgba(0,0,0,0.7); border:none; padding:.5rem; border-radius:.25rem; cursor:pointer; color:white; font-size:1.2rem; }
    .volume-slider { width:100px; }

    /* Mobile swipe overlay */
    #mobileSwipeOverlay {
      position:absolute; top:0; left:0; width:100%; height:100%;
      display:none; pointer-events:none; z-index:1000;
    }

    /* –û—Ç–∫–ª—é—á–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Å—Ç—Ä–µ–ª–∫–∏ Reveal */
    .reveal.player-container { width:100vw; height:100vh; }
    .reveal .slides { margin:0; padding:0; }
    .reveal .navigate-left, .reveal .navigate-right { display:none; }
  </style>
</head>
<body>

  <div class="reveal player-container" id="revealContainer">

    <!-- Studio Branding & Chapter Dropdown -->
    <div class="studio-branding">
      <div class="studio-brand-block"><span class="studio-name">VAMPUCA AI</span></div>
      <div class="dropdown-button-container">
        <button class="dropdown-button" id="dropdownButton">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6"/>
          </svg>
        </button>
        <div id="dropdownMenu" class="dropdown-menu">
          <div class="dropdown-header">Select Chapter</div>
          <div class="chapter-list" id="chapterList"></div>
        </div>
      </div>
    </div>

    <!-- Slide Counter -->
    <div class="slide-counter"><span id="slideCounter">Title / 22</span></div>

    <!-- Video + Loading + Swipe Overlay -->
    <div class="video-container" id="videoContainer">
      <video id="mainVideo" class="main-video" preload="none" playsinline webkit-playsinline muted></video>
      <div id="loadingState" class="loading-state hidden">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
      </div>
      <div id="mobileSwipeOverlay"></div>
    </div>

    <!-- Controls -->
    <div class="controls-container" id="controlsContainer">
      <button id="prevBtn">‚Äπ</button>
      <button id="playBtn">
        <span id="playIcon">‚ñ∂Ô∏è</span>
        <span id="pauseIcon" class="hidden">‚è∏Ô∏è</span>
      </button>
      <button id="muteBtn">
        <span id="muteIcon">üîä</span>
        <span id="mutedIcon" class="hidden">üîá</span>
      </button>
      <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50"/>
      <button id="nextBtn">‚Ä∫</button>
      <button id="fullscreenBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
        </svg>
      </button>
    </div>

    <!-- Reveal.js Slides -->
    <div class="slides">
      <!-- 22 –ø—É—Å—Ç—ã—Ö —Å–µ–∫—Ü–∏–π, Reveal –±—É–¥–µ—Ç –∏—Ö –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å -->
      <section></section><section></section><section></section><section></section><section></section>
      <section></section><section></section><section></section><section></section><section></section>
      <section></section><section></section><section></section><section></section><section></section>
      <section></section><section></section><section></section><section></section><section></section>
      <section></section><section></section>
    </div>

  </div>

  <!-- Reveal.js + Video plugin + Hammer.js -->
  <script src="https://unpkg.com/reveal.js/dist/reveal.js"></script>
  <script src="https://unpkg.com/reveal.js/plugin/video/video.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>

  <script>
    // === –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Reveal.js ===
    Reveal.initialize({
      controls: false,
      progress: false,
      slideNumber: false,
      hash: false,
      touch: true,
      transition: 'none',
      dependencies: [
        { src: 'https://unpkg.com/reveal.js/plugin/video/video.js', async: true }
      ]
    });

    // –ü—Ä–∏ —Å–º–µ–Ω–µ —Å–ª–∞–π–¥–∞ ‚Äî –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ:
    Reveal.on('slidechanged', ({ indexh }) => {
      loadVideo(indexh, true);
    });

    // --- –¢–≤–æ–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π JS-–∫–æ–¥ –Ω–∏–∂–µ ---

    // Robust mobile detection
    function isReallyMobile() {
        const result = (
            /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
            (typeof window.orientation !== 'undefined') ||
            window.innerWidth <= 800
        );
        console.log('isReallyMobile:', result, navigator.userAgent, window.innerWidth);
        return result;
    }

    // Video sources
    const videoSources = [
        { id: 1, src: 'KLKT_TITLE.m4v', title: 'Title' },
        ...Array.from({ length: 20 }, (_, i) => ({
            id: i + 2,
            src: `KLKT_${i + 1}.m4v`,
            title: `Chapter ${i + 1}`
        })),
        { id: 22, src: 'KLKT_END.m4v', title: 'End' }
    ];

    // DOM elements
    const playerContainer = document.getElementById('revealContainer');
    const videoContainer = document.getElementById('videoContainer');
    const mainVideo = document.getElementById('mainVideo');
    const loadingState = document.getElementById('loadingState');
    const loadingText = document.getElementById('loadingText');
    const controlsContainer = document.getElementById('controlsContainer');
    const playBtn = document.getElementById('playBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const muteBtn = document.getElementById('muteBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const dropdownButton = document.getElementById('dropdownButton');
    const dropdownMenu = document.getElementById('dropdownMenu');
    const chapterList = document.getElementById('chapterList');
    const slideCounterElem = document.getElementById('slideCounter');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');
    const muteIcon = document.getElementById('muteIcon');
    const mutedIcon = document.getElementById('mutedIcon');
    const volumeSlider = document.getElementById('volumeSlider');
    const overlay = document.getElementById('mobileSwipeOverlay');

    // State
    let currentSlide = 0;
    let isPlaying = false;
    let isMuted = false;
    let showDropdown = false;
    let controlsTimeout;
    let currentBlobURL = null;

    // Touch handling
    let touchStart = { x: 0, y: 0 };
    let touchEnd = { x: 0, y: 0 };

    function handleTouchStart(e) {
        if (!isReallyMobile()) return;
        touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        e.preventDefault();
    }
    function handleTouchMove(e) {
        if (!isReallyMobile()) return;
        e.preventDefault();
    }
    async function handleTouchEnd(e) {
        if (!isReallyMobile()) return;
        touchEnd = { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
        const deltaX = touchEnd.x - touchStart.x;
        if (Math.abs(deltaX) > 50) {
            if (deltaX > 0) await goToPrevious();
            else await goToNext();
        }
        e.preventDefault();
    }

    function enableMobileSwipe() {
        if (!isReallyMobile()) {
            overlay.style.display = 'none';
            overlay.style.pointerEvents = 'none';
            videoContainer.removeEventListener('touchstart', handleTouchStart);
            videoContainer.removeEventListener('touchmove', handleTouchMove);
            videoContainer.removeEventListener('touchend', handleTouchEnd);
            if (overlay._hammer) {
                overlay._hammer.destroy();
                overlay._hammer = null;
            }
            return;
        }
        overlay.style.display = 'block';
        overlay.style.pointerEvents = 'auto';
        videoContainer.addEventListener('touchstart', handleTouchStart, { passive: false });
        videoContainer.addEventListener('touchmove', handleTouchMove, { passive: false });
        videoContainer.addEventListener('touchend', handleTouchEnd, { passive: false });
        if (!overlay._hammer) {
            const hammer = new Hammer(overlay);
            overlay._hammer = hammer;
            hammer.on('swipeleft', async () => await goToNext());
            hammer.on('swiperight', async () => await goToPrevious());
        }
        mainVideo.addEventListener('contextmenu', e => { e.preventDefault(); return false; });
    }
    window.addEventListener('resize', enableMobileSwipe);
    window.addEventListener('orientationchange', enableMobileSwipe);

    document.addEventListener('fullscreenchange', () => {});
    document.addEventListener('webkitfullscreenchange', () => {});
    document.addEventListener('mozfullscreenchange', () => {});
    document.addEventListener('MSFullscreenChange', () => {});

    async function loadVideoBlob(src) {
        const resp = await fetch(src);
        const data = await resp.arrayBuffer();
        const blob = new Blob([data], { type: 'application/octet-stream' });
        if (currentBlobURL) URL.revokeObjectURL(currentBlobURL);
        const url = URL.createObjectURL(blob);
        currentBlobURL = url;
        mainVideo.src = url;
        mainVideo.load();
        mainVideo.currentTime = 0;
        mainVideo.muted = isMuted;
        return new Promise(resolve => {
            mainVideo.addEventListener('loadeddata', function onLoaded() {
                mainVideo.removeEventListener('loadeddata', onLoaded);
                loadingState.classList.add('hidden');
                resolve();
            });
        });
    }

    async function loadVideo(index, autoplay = false) {
        if (index < 0 || index >= videoSources.length) return;
        currentSlide = index;
        isPlaying = false;
        loadingState.classList.remove('hidden');
        loadingText.textContent = `Loading ${videoSources[index].title}...`;
        mainVideo.pause();
        const videoSrc = videoSources[index].src;
        if (isReallyMobile()) {
            try {
                await loadVideoBlob(videoSrc);
                if (autoplay) { mainVideo.play().catch(()=>{}); isPlaying = true; updatePlayButton(); }
            } catch {
                mainVideo.src = videoSrc;
                mainVideo.load();
                mainVideo.currentTime = 0;
                mainVideo.muted = isMuted;
                mainVideo.addEventListener('loadeddata', function onLoaded() {
                    mainVideo.removeEventListener('loadeddata', onLoaded);
                    loadingState.classList.add('hidden');
                    if (autoplay) { mainVideo.play().catch(()=>{}); isPlaying = true; updatePlayButton(); }
                });
            }
        } else {
            if (mainVideo.src !== videoSrc) {
                mainVideo.src = videoSrc;
                mainVideo.load();
            }
            mainVideo.currentTime = 0;
            mainVideo.muted = isMuted;
            mainVideo.addEventListener('loadeddata', function onLoaded() {
                mainVideo.removeEventListener('loadeddata', onLoaded);
                loadingState.classList.add('hidden');
                if (autoplay) { mainVideo.play().catch(()=>{}); isPlaying = true; updatePlayButton(); }
            });
        }
        updateSlideCounter();
        updateChapterList();
        updateControls();
    }

    function updatePlayButton() {
        if (isPlaying) { playIcon.classList.add('hidden'); pauseIcon.classList.remove('hidden'); }
        else { playIcon.classList.remove('hidden'); pauseIcon.classList.add('hidden'); }
    }
    function updateMuteButton() {
        if (isMuted) { muteIcon.classList.add('hidden'); mutedIcon.classList.remove('hidden'); }
        else { muteIcon.classList.remove('hidden'); mutedIcon.classList.add('hidden'); }
    }
    function updateSlideCounter() {
        let displayText;
        if (currentSlide === 0) displayText = 'Title';
        else if (currentSlide === videoSources.length - 1) displayText = 'End';
        else displayText = `Chapter ${currentSlide}`;
        slideCounterElem.textContent = `${displayText} / ${videoSources.length}`;
    }
    function updateChapterList() {
        chapterList.querySelectorAll('.chapter-item').forEach((item, idx) => {
            idx === currentSlide ? item.classList.add('active') : item.classList.remove('active');
        });
    }
    function updateControls() {
        prevBtn.style.display = currentSlide === 0 ? 'none' : 'flex';
        playBtn.style.display = currentSlide === 0 ? 'none' : 'flex';
        nextBtn.style.display = currentSlide === videoSources.length - 1 ? 'none' : 'flex';
    }

    function generateChapterList() {
        chapterList.innerHTML = '';
        videoSources.forEach((video, idx) => {
            const btn = document.createElement('button');
            btn.className = 'chapter-item';
            btn.innerHTML = `<span>${video.title}</span><span class="chapter-indicator">‚Ä∫</span>`;
            btn.addEventListener('click', async () => { await loadVideo(idx, true); toggleDropdown(); });
            chapterList.appendChild(btn);
        });
    }

    async function goToPrevious() { if (currentSlide > 0) await loadVideo(currentSlide - 1, true); }
    async function goToNext()     { if (currentSlide < videoSources.length - 1) await loadVideo(currentSlide + 1, true); }

    playBtn.addEventListener('click', () => {
        if (isPlaying) { mainVideo.pause(); isPlaying = false; }
        else { if (isMuted) { isMuted = false; mainVideo.muted = false; updateMuteButton(); } mainVideo.play().catch(()=>{}); isPlaying = true; }
        updatePlayButton();
    });
    muteBtn.addEventListener('click', () => {
        isMuted = !isMuted; mainVideo.muted = isMuted; updateMuteButton();
    });
    volumeSlider.addEventListener('input', e => {
        const v = e.target.value/100; mainVideo.volume = v; isMuted = v===0; mainVideo.muted = isMuted; updateMuteButton();
    });

    function enterFullscreen() {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        if (isIOS && isSafari && mainVideo.webkitEnterFullscreen) mainVideo.webkitEnterFullscreen();
        else if (playerContainer.requestFullscreen) playerContainer.requestFullscreen();
        else if (playerContainer.webkitRequestFullscreen) playerContainer.webkitRequestFullscreen();
        else if (playerContainer.msRequestFullscreen) playerContainer.msRequestFullscreen();
    }
    fullscreenBtn.addEventListener('click', enterFullscreen);

    dropdownButton.addEventListener('click', e => {
        e.stopPropagation(); toggleDropdown();
        if (isReallyMobile()) {
            overlay.style.display = showDropdown ? 'none' : 'block';
            overlay.style.pointerEvents = showDropdown ? 'none' : 'auto';
        }
    });
    document.addEventListener('click', e => {
        if (!e.target.closest('.dropdown-button-container') && showDropdown) {
            toggleDropdown();
            if (isReallyMobile()) { overlay.style.display = 'block'; overlay.style.pointerEvents = 'auto'; }
        }
    });

    function showControlsTemporarily() {
        controlsContainer.classList.remove('hidden');
        clearTimeout(controlsTimeout);
        controlsTimeout = setTimeout(() => controlsContainer.classList.add('hidden'), 1500);
    }
    document.addEventListener('mousemove', showControlsTemporarily);
    document.addEventListener('touchstart', showControlsTemporarily);
    videoContainer.addEventListener('click', showControlsTemporarily);

    prevBtn.addEventListener('click', async () => await goToPrevious());
    nextBtn.addEventListener('click', async () => await goToNext());

    document.addEventListener('keydown', async e => {
        if (e.key===' '||e.key==='Spacebar') { playBtn.click(); e.preventDefault(); }
        else if (e.key==='ArrowLeft') await goToPrevious();
        else if (e.key==='ArrowRight') await goToNext();
        else if (e.key==='f') fullscreenBtn.click();
        else if (e.key==='m') muteBtn.click();
    });

    function toggleDropdown() {
        showDropdown = !showDropdown;
        dropdownMenu.classList.toggle('visible', showDropdown);
    }

    async function initialize() {
        enableMobileSwipe();
        generateChapterList();
        await loadVideo(0);
        showControlsTemporarily();
    }
    document.addEventListener('DOMContentLoaded', initialize);

    // --- –ö–æ–Ω–µ—Ü —Ç–≤–æ–µ–≥–æ JS ---
  </script>

</body>
</html>
